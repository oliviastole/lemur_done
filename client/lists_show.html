<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>Lists</title>
</head>

<body>

    <br>
    <button id="edit">Edit user</button>
    <button id="public">Show public lists</button>

    <p>Logged in as:</p>
    <p id="userName"></p>

    <h1>To do list</h1>
    <button id="btn3">Create new list</button>
    <br>
    <hr>
    <div id="container"></div>
    
    <p id="outtext"></p>

</body>

<script>

    // ---------------------------------------    
    
    let container = document.getElementById("container");
    let url = "/lists";

    let token = localStorage.getItem("token");


    function editUser() {
        location.href = "user_edit.html";
    }

    function showPublic() {
        location.href = "list_public.html";
    }

   function newList() {
        location.href = "lists_create.html";
    }

    

    let edit = document.getElementById("edit");
    edit.addEventListener("click", editUser);

    let public = document.getElementById("public");
    public.addEventListener("click", showPublic);

    let btn3 = document.getElementById("btn3");
    btn3.addEventListener("click", newList);

    

    loadLists();

    //-----------------------------------------

    async function loadLists() {

        container.innerHTML = "";

        let cfg = {
            method: "GET",
            headers: {"auth" : token}
        }

        let response = await fetch(url, cfg);
        let data = await response.json();


        if (response.status == 200){
            for(let list of data) {
            let div = document.createElement("div");
            let html = `
                <h3>${list.list_name}</h3>
                <p>${list.comm}</p>            
            `;

            let btn = document.createElement("button");
            btn.innerHTML = "Delete list";
            let hr = document.createElement("hr");

            let btn2 = document.createElement("button");
            btn2.innerHTML = "Show list items";

            let btn1 = document.createElement("button");
            btn1.innerHTML = "Edit list";

            div.innerHTML = html;
            div.appendChild(btn1);
            div.appendChild(btn2);
            div.appendChild(btn);
            div.appendChild(hr);
            container.appendChild(div);

            btn1.addEventListener("click", function(){
                localStorage.setItem("listid", list.id);
                localStorage.setItem("listname", list.list_name);
                localStorage.setItem("listcomm", list.comm);
                location.href = "list_update.html";
            });

            btn2.addEventListener("click", function(){
                localStorage.setItem("listid", list.id);
                localStorage.setItem("listname", list.list_name);
                location.href = "listitem_show.html"; 
            });

            btn.addEventListener("click", function(){
                del(list.id);
            });

            }
        }

        else if (response.status == 403){
            location.href = "failed_login.html";
        }

        else {
            location.href = "error.html";
        }

        let [userid, username, sign] = token.split(",");
        userName.innerHTML = [username];
    }


    async function del(listeid) {

        let updata = {
            id: listeid
        }

        let cfg = {
            method: "DELETE",
            headers: {
                "content-type" : "application/json",
                "auth" : token
            },
            body: JSON.stringify(updata)
        }

        let response = await fetch(url, cfg);
        let data = await response.json();

        loadLists();
    }   

    

</script>

</html>